# üíä Otimizador de Margem Farmac√™utica (CNPME) - Documenta√ß√£o do Projeto

**Estado Atual:** üü¢ Funcional / Est√°vel / Interface "PharmaTouch"
**Data da √öltima Revis√£o:** 28/01/2026

---

## 1. Vis√£o Geral e Objetivo
Sistema de Business Intelligence para farm√°cias comunit√°rias focado na **maximiza√ß√£o da margem de lucro** atrav√©s da substitui√ß√£o inteligente de gen√©ricos. O sistema cruza dados reais de vendas com o portef√≥lio nacional (Infarmed) e acordos comerciais (Descontos), sugerindo trocas que respeitam o grupo terap√™utico (CNPEM) e a sensibilidade ao pre√ßo do utente.

## 2. Arquitetura T√©cnica

### Estrutura de Ficheiros
*   **`app.py`:** "C√©rebro" da aplica√ß√£o. Cont√©m toda a l√≥gica de ingest√£o, processamento, c√°lculo e interface. Substituiu os antigos scripts auxiliares (`process_*.py`) para permitir processamento din√¢mico "on-the-fly".
*   **`ui_style.py`:** M√≥dulo de design. Define o tema "PharmaTouch Glass" (CSS, cores, m√©tricas).
*   **`requirements.txt`:** Depend√™ncias estritas (`streamlit`, `pandas`, `openpyxl`, `xlrd`).
*   **`.gitignore`:** Seguran√ßa. Bloqueia o upload de dados sens√≠veis (`*.csv`, `*.xls`, `*.txt`).

### Input de Dados
O sistema ingere 3 ficheiros cr√≠ticos na barra lateral:
1.  **Vendas (Infoprex):** `.txt` ou `.csv`. Fonte da verdade sobre o que se vende e o stock atual.
2.  **Mestre (Infarmed):** `.xls`. Fonte oficial de PVPs, comparticipa√ß√µes e grupos homog√©neos.
3.  **Descontos:** `.xlsx` (Colunas: `CNP`, `DESC`). Fonte das condi√ß√µes comerciais negociadas.

---

## 3. L√≥gica de Neg√≥cio (O "Cora√ß√£o" do Algoritmo)

### A. O Dilema do "Stock de Campanha"
Um dos maiores desafios resolvidos foi evitar sugest√µes erradas quando a farm√°cia tem stock comprado em campanha (custo muito baixo) vs. uma nova op√ß√£o de mercado.

**Solu√ß√£o Implementada (Dual Check):**
O sistema calcula dois tipos de margem para cada produto:
1.  **Margem Real (Stock):** `(PVP/1.06) - PCU_M√©dio_Atual`. Reflete o lucro de vender o que est√° na prateleira.
2.  **Margem Te√≥rica (Reposi√ß√£o):** `(PVP/1.06) - (PVA * (1 - Desconto_Negociado))`. Reflete o lucro de comprar este produto *hoje*.

**Matriz de Decis√£o:**
*   **"Trocar J√° üîÑ":** A Nova Op√ß√£o tem uma margem *superior* √† Margem Real do Stock atual. (Ganho imediato absoluto).
*   **"Esgotar üìâ":** A Nova Op√ß√£o √© pior que o Stock atual (porque foi comprado barato), mas √© *melhor* que a Margem Te√≥rica do produto atual. (A√ß√£o: Vender o stock todo e, na pr√≥xima encomenda, mudar de marca).

### B. Gest√£o de Pre√ßos (Regimes)
*   **Switch Utente/Pensionista:** O sistema ajusta dinamicamente a coluna de pre√ßo (`Pre√ßo Utente` vs `Pre√ßo Pensionistas`) e o t√≠tulo das colunas, essencial para produtos onde o PVP5 altera drasticamente o valor a pagar.
*   **Toler√¢ncia:** Input livre para definir quanto a mais o utente aceita pagar (ex: +0.50‚Ç¨).

---

## 4. Corre√ß√µes Cr√≠ticas e Estabiliza√ß√£o

Durante o desenvolvimento, foram resolvidos v√°rios pontos de falha:

1.  **Duplica√ß√£o de Dados (Infoprex):**
    *   *Problema:* O ficheiro de vendas continha m√∫ltiplas linhas para o mesmo produto devido a diferentes "Localiza√ß√µes" ou datas.
    *   *Solu√ß√£o:* Implementado filtro autom√°tico que deteta a `DUV` (Data √öltima Venda) mais recente e filtra apenas a `LOCALIZACAO` correspondente.

2.  **Robustez na Leitura de Ficheiros:**
    *   *Problema:* Erros de `UnicodeDecodeError` e `ParserError` devido a formatos antigos (`latin-1`, separadores `	` vs `;`).
    *   *Solu√ß√£o:* Loop de tentativa/erro inteligente que testa combina√ß√µes de *Encodings* e *Separadores* at√© encontrar uma estrutura tabular v√°lida (>1 coluna).

3.  **Desaparecimento de Dados (KeyErrors):**
    *   *Problema:* O `merge` do Pandas criava sufixos (`_x`, `_y`) destruindo a coluna chave `CNPEM`.
    *   *Solu√ß√£o:* Sele√ß√£o expl√≠cita de colunas (`sales_cols_keep`) antes do merge e normaliza√ß√£o for√ßada dos nomes (`Subst√¢ncia Ativa` -> `GRUPOHOMOGENEO`, `N¬∫ registo` -> `N_REGISTO`) logo na ingest√£o.

4.  **Inconsist√™ncia de Tipos (IDs):**
    *   *Solu√ß√£o:* Limpeza agressiva de IDs (`.astype(str).str.split('.').str[0]`) para garantir que `12345` (Excel) casa com `12345.0` (CSV).

---

## 5. Pipeline de Dados (Fluxo)

1.  **Ingest√£o:** Upload dos 3 ficheiros.
2.  **Normaliza√ß√£o:** Renomea√ß√£o de colunas para padr√£o interno.
3.  **Enriquecimento Mestre:** C√°lculo de `PVA` (f√≥rmula oficial) e `Margem Te√≥rica` (com ficheiro Descontos).
4.  **Limpeza Vendas:** Filtro de Localiza√ß√£o + C√°lculo `Margem Real`.
5.  **Merge:** `Inner Join` entre Vendas e Mestre (apenas produtos vendidos s√£o analisados).
6.  **An√°lise ABC:** Agrupamento por `CNPEM`, ordena√ß√£o por Margem Total e classifica√ß√£o Pareto.
7.  **Simula√ß√£o:** Itera√ß√£o linha a linha com l√≥gica comparativa e renderiza√ß√£o visual.

---

## 6. Notas Finais
Este projeto est√° pronto para produ√ß√£o local. A separa√ß√£o entre L√≥gica (`app.py`) e Estilo (`ui_style.py`) facilita a manuten√ß√£o futura. O sistema de leitura √© agn√≥stico a pequenas varia√ß√µes de formato do Infoprex, garantindo longevidade.
